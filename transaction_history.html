<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
<style>
    body {
        font-family: "Sarabun", "Segoe UI", sans-serif;
        background-color: #f8f9fa;
    }
    h1 {
        margin-bottom: 30px;
        text-align: center;
        font-weight: bold;
    }
    .table-hover tbody tr:hover {
        background-color: #f1f3f5;
    }
    .badge-borrow {
        background-color: #dc3545;
    }
    .badge-return {
        background-color: #198754;
    }
    .note-input {
        width: 70%;
        display: inline-block;
    }
</style>
</head>
<body>
<div class="container my-5">
    <h1>üìú ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</h1>
    <div class="text-center mb-4">
        <a href="{% url 'inventory' %}" class="btn btn-secondary shadow-sm px-4">‚Üê ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏Ñ‡∏•‡∏±‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</a>
    </div>

    <!-- ‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏Å‡∏£‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà -->
    <form method="get" class="row g-3 mb-4 justify-content-center">
        <div class="col-md-3 col-6">
            <label class="form-label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</label>
            <input type="date" name="start_date" value="{{ request.GET.start_date }}" class="form-control shadow-sm">
        </div>
        <div class="col-md-3 col-6">
            <label class="form-label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î</label>
            <input type="date" name="end_date" value="{{ request.GET.end_date }}" class="form-control shadow-sm">
        </div>
        <div class="col-md-2 col-6 align-self-end">
            <button type="submit" class="btn btn-primary w-100 shadow-sm">‡∏Å‡∏£‡∏≠‡∏á</button>
        </div>
        <div class="col-md-2 col-6 align-self-end">
            <a href="{% url 'transaction_history' %}" class="btn btn-outline-secondary w-100 shadow-sm">‡∏•‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á</a>
        </div>
    </form>

    <div class="table-responsive shadow-sm rounded">
        <table class="table table-bordered table-striped table-hover align-middle mb-0">
            <thead class="table-dark text-center">
                <tr>
                    <th style="min-width:120px;">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                    <th>‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                    <th>‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó</th>
                    <th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
                    <th>‡∏ú‡∏π‡πâ‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
                    <th>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
                    <th>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
                </tr>
            </thead>
            <tbody>
                {% for t in transactions %}
                <tr data-id="{{ t.id }}">
                    <td class="text-center">{{ t.timestamp|date:"d/m/Y H:i" }}</td>
                    <td>{{ t.item.name }}</td>
                    <td class="text-center">{{ t.item.company }}</td>
                    <td class="text-center">{{ t.quantity }} {{ t.item.unit }}</td>
                    <td class="text-center">{{ t.user_name }}</td>
                    <td class="text-center">
                        {% if t.action == 'use' %}
                            <span class="badge badge-borrow">‡∏ô‡∏≥‡∏≠‡∏≠‡∏Å‡πÑ‡∏õ‡πÉ‡∏ä‡πâ</span>
                        {% elif t.action == 'add' %}
                            <span class="badge bg-primary">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</span>
                        {% else %}
                            <span class="badge badge-return">‡∏Ç‡∏≤‡∏¢</span>
                        {% endif %}
                    </td>
                    <td>
                        <span class="note-text">{{ t.note|default:"-" }}</span>
                        <button type="button" class="btn btn-sm btn-outline-secondary ms-2 edit-note-btn">‚úèÔ∏è</button>
                    </td>
                </tr>
                {% empty %}
                <tr><td colspan="7" class="text-center text-muted py-4">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
document.querySelectorAll('.edit-note-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        const td = this.closest('td');
        const span = td.querySelector('.note-text');
        const currentNote = span.textContent === "-" ? "" : span.textContent;

        // ‡∏™‡∏£‡πâ‡∏≤‡∏á input ‡πÅ‡∏•‡∏∞‡∏õ‡∏∏‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
        const input = document.createElement('input');
        input.type = 'text';
        input.value = currentNote;
        input.className = 'form-control form-control-sm note-input d-inline';

        const saveBtn = document.createElement('button');
        saveBtn.textContent = 'üíæ';
        saveBtn.className = 'btn btn-sm btn-success ms-1';

        // ‡∏ã‡πà‡∏≠‡∏ô span ‡πÅ‡∏•‡∏∞‡∏õ‡∏∏‡πà‡∏°‡∏î‡∏¥‡∏ô‡∏™‡∏≠
        span.style.display = 'none';
        this.style.display = 'none';

        td.appendChild(input);
        td.appendChild(saveBtn);

        saveBtn.addEventListener('click', function() {
            const newNote = input.value;
            const transactionId = td.closest('tr').dataset.id;

            fetch("{% url 'update_transaction_note' %}", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": "{{ csrf_token }}",
                },
                body: JSON.stringify({ id: transactionId, note: newNote })
            })
            .then(res => res.json())
            .then(data => {
                if(data.success){
                    span.textContent = newNote || "-";
                    span.style.display = 'inline';
                    input.remove();
                    saveBtn.remove();
                    btn.style.display = 'inline-block';
                } else {
                    alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
                }
            })
            .catch(err => {
                console.error(err);
                alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î");
            });
        });
    });
});
</script>
</body>
</html>
